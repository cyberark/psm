---

- hosts: localhost
  connection: local
  
  tasks:
  
  
    - name: spin up EC2 instance
      ec2:
        aws_access_key: "{{aws_access_key | default(omit) }}"
        aws_secret_key: "{{aws_secret_key | default(omit)}}"
        security_token: "{{aws_security_token | default(omit)}}"
        key_name: "AutoAMI-KeyPair"
        instance_type: "m4.large"
        image: "ami-01776b82784323238"
        wait: yes
        group_id: "sg-e0344f98"
        count: 1
        vpc_subnet_id: "subnet-dffe2084"
        assign_public_ip: yes
        region: eu-west-1
        instance_tags: 
          "{'Name':'[Orch]-PSM-{{ lookup('pipe','date +%Y-%m-%d-%H-%M-%S') }}', 'create_time': '{{ lookup('pipe','date +%Y-%m-%d-%H-%M-%S') }}'}"
        user_data: |
          <powershell>
            # Change Password
            $admin = [adsi]("WinNT://./administrator, user")
            $admin.PSBase.Invoke("SetPassword", "{{ ansible_password }}")
            
            # Configure machine for ansible remoting
            $url = "https://raw.githubusercontent.com/ansible/ansible/devel/examples/scripts/ConfigureRemotingForAnsible.ps1"
            $file = "$env:temp\ConfigureRemotingForAnsible.ps1"
            (New-Object -TypeName System.Net.WebClient).DownloadFile($url, $file)
            powershell.exe -ExecutionPolicy ByPass -File $file -EnableCredSSP
            </powershell>
      delegate_to: localhost
      register: ec2_details
      
    - add_host:
        hostname: "{{ec2_details.instances[0].public_ip}}"
        groups: windows

- hosts: windows
  connection: local
  gather_facts: false
  
  vars_prompt:
    - name: vault_password
      prompt: "Please enter the Vault password"
      private: yes
      
  tasks:
  
    - name: wait for port 5986 on destination instance
      wait_for_connection:
        delay: 20
        timeout: 600
  
    - include_role: 
        name: ../psm
      vars:
        - accept_eula: "YeS"
        - psm_extract: true
        - psm_prerequisites: true
        - psm_install: true
        - psm_postinstall: true
        - psm_hardening: true
        - psm_registration: true
        - psm_zip_file_path: "/tmp/pas_packages/psm.zip"
        - vault_port: 1858
        - vault_username: administrator