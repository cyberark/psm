---
# tasks file for psm prerequisities

- name: update NLA & UpdateRDSSecurityLayer installation
  win_shell: |
    try
    {
        $disableNLA = if('{{ psm_disable_nla }}' -eq 'true') {"Yes"} else {"No"}
        $filePath = "{{ psm_installationautomation_folder }}\\Prerequisites\\PrerequisitesConfig.xml"
        $xml = [xml](Get-Content $filePath)
        #$xml.Stage.Step | Where-Object {$_.Name -eq "UpdateRDSSecurityLayer"}
        $step1 = $xml.SelectSingleNode("//Step[@Name = 'DisableNLA']")
        $step1.Enable = $disableNLA
        $step2 = $xml.SelectSingleNode("//Step[@Name = 'UpdateRDSSecurityLayer']")
        $step2.Enable = 'Yes'
        $xml.Save($filePath)
        exit 0
    }
    catch
    {
        Write-Output "Error occured during SetAtrributeInXML"
        exit 1
    }

- name: execute psm prerequisities
  win_shell: |
    
    $RegPath = "HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon"
    Set-ItemProperty $RegPath "AutoAdminLogon" -Value "1" -type String  
    Set-ItemProperty $RegPath "DefaultUsername" -Value {{ ansible_user }} -type String  
    Set-ItemProperty $RegPath "DefaultPassword" -Value {{ ansible_password }} -type String
    
    Set-Location "{{ psm_installationautomation_folder }}"
    $Action = .\Execute-Stage.ps1 "{{ psm_installationautomation_folder }}\Prerequisites\PrerequisitesConfig.xml" -displayJson -delayedrestart
    $Action | Out-File -FilePath "{{ psm_installationautomation_folder }}\psm_pre_req_result.txt"
    $Result = Get-Content "{{ psm_installationautomation_folder }}\psm_pre_req_result.txt" | ConvertFrom-Json
    if ($Result.isSucceeded -ne 0) {
        exit 1
    } else {
        exit 0
    }

- win_reboot:
    reboot_timeout: 300
    
- name: continue execute psm prerequisities after restart
  win_shell: |
    
    Set-Location "{{ psm_installationautomation_folder }}"
    $Action = .\Execute-Stage.ps1 "{{ psm_installationautomation_folder }}\Prerequisites\PrerequisitesConfig.xml" -displayJson
    $Action | Out-File -FilePath "{{ psm_installationautomation_folder }}\psm_pre_req_result.txt"
    $Result = Get-Content "{{ psm_installationautomation_folder }}\psm_pre_req_result.txt" | ConvertFrom-Json
    if ($Result.isSucceeded -eq 2) {
        exit 1
    } else {
        exit 0
    }