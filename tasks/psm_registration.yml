---
<<<<<<< HEAD
# tasks file for cpm registration
- name: validate if pvwa ip is defined
  fail:
    msg: "PVWA ip must be sent in order to register PSM"
  when: pvwa_ip is not defined
  
- name: copy ps1 script to server
  win_copy:
    src: "./files/add_admin_to_psmmaster.ps1 {{ vault_username }} {{ vault_password }} {{ pvwa_url }}"
    dest: "{{ psm_registrationtool_folder }}"

- name: add user administrator to PSMMaster group
  win_command: "powershell.exe -file {{ psm_registrationtool_folder }}\\add_admin_to_psmmaster.ps1 -username {{ vault_username }} -password {{ vault_password }} -$pvwaIp {{ pvwa_url }}"
=======
# tasks file for psm registration
>>>>>>> develop

- name: Execute psm registration
  win_command: 'RegisterComponent.exe PSM /accepteula Yes /vaultip {{ vault_ip }} /vaultport {{ vault_port }} /vaultuser {{ vault_username }} /vaultpassword {{ vault_password }} /psminstalldir "{{ psm_installation_path }}"'
  args:
    chdir: "{{ psm_registrationtool_folder }}"

- name: start psm service & set to auto
  win_service:
    name: "{{ psm_service_name }}"
    start_mode: auto
    state: started

- name: check if psm service is running
  win_service: 
    name: "{{ psm_service_name }}"
  register: psm_service_info
  
- set_fact:
    psm_registered: true
  when: psm_service_info.state == "running" 
  