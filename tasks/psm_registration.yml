---
# tasks file for cpm registration
- name: validate if pvwa ip is defined
  fail:
    msg: "PVWA ip must be sent in order to register PSM"
  when: pvwa_ip is not defined
  
- name: copy ps1 script to server
  win_copy:
    src: "./files/add_admin_to_psmmaster.ps1 {{ vault_username }} {{ vault_password }} {{ pvwa_url }}"
    dest: "{{ psm_registrationtool_folder }}"

- name: add user administrator to PSMMaster group
  win_command: "powershell.exe -file {{ psm_registrationtool_folder }}\\add_admin_to_psmmaster.ps1 -username {{ vault_username }} -password {{ vault_password }} -$pvwaIp {{ pvwa_url }}"

- name: Execute cpm registration
  win_command: 'RegisterComponent.exe CPM /accepteula Yes /vaultip {{ vault_ip }} /vaultport {{ vault_port }} /vaultuser {{ vault_username }} /vaultpassword {{ vault_password }} /installdir "{{ cpm_installation_path }}"'
  args:
    chdir: "{{ cpm_registrationtool_folder }}"

# TODO: Validate CPM registration

- name: start cpm service & set to auto
  win_service:
    name: "{{ cpm_service_name }}"
    start_mode: auto
    state: started
    
- name: start cpm scanner service & set to auto
  win_service:
    name: "{{ cpm_scanner_service_name }}"
    start_mode: auto
    state: started
    

- name: check if cpm service is running
  win_service: 
    name: "{{ cpm_service_name }}"
  register: cpm_service_info
  
- name: check if cpm scanner service is running
  win_service: 
    name: "{{ cpm_scanner_service_name }}"
  register: cpm_scanner_service_info

- set_fact:
    cpm_registered: true
  when: cpm_service_info.state == "running" and cpm_scanner_service_info.state == "running"
  